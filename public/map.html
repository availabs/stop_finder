<script src="http://cdn.leafletjs.com/leaflet-0.7.1/leaflet.js"></script>
<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.1/leaflet.css">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css" integrity="sha384-PsH8R72JQ3SOdhVi3uxftmaW6Vc51MKb0q5P2rRUpPvrszuE4W1povHYgTpBfshb" crossorigin="anonymous">
<script src="https://d3js.org/d3.v4.min.js" /></script>
<link rel="stylesheet" href="/stylesheets/style.css">
<div class="row">
  <div id="map" style="height:750px" class="col-8 leaflet-container leaflet-fade-anim" tabindex="0"></div>
  <div class="col-4" id="stops">
  </div>
</div>
<script>
  function getSearchParameters() {
    var prmstr = window.location.search.substr(1);
    return prmstr != null && prmstr != "" ? transformToAssocArray(prmstr) : {};
  }

  function transformToAssocArray( prmstr ) {
    var params = {};
    var prmarr = prmstr.split("&");
    for ( var i = 0; i < prmarr.length; i++) {
        var tmparr = prmarr[i].split("=");
        params[tmparr[0]] = tmparr[1];
    }
    return params;
  }
  
  var params = getSearchParameters();

  var start = [ 
    params.lat || 40.487692978918865,
    params.lng || -74.38568115234375
  ]

  var stopIcons = []
   
  //Data from API that will be displayed (subset of those actually retreived)
  var displayedDataKeys = ['stop_id','stop_code','route_ids']

  //Formatting for above keys
  var formattedDataKeys = {
    'stop_id':"Stop ID",
    'stop_code':"Stop Code",
    'route_ids':"Route IDs"
  }

  //Removes all old highlighted stops (in list-div)
  //Highlights the corresponding "stop_id" 
  function backgroundColorToggle(stop_id){
    var allStopDivs = d3.select("#stops").selectAll("div")
    allStopDivs.style("background-color","")
    var stopDiv = d3.select("div.stop_"+stop_id)

    stopDiv.style("background-color","white")  
  }

  /*
  *
  * LEAFLET TAKES COORDS AS: LAT/LNG
  * POSTGIS TAKES COORDS AS: LNG/LAT
  * Parameter is LAT/LNG in order to work with Leaflet
  * Function reverses it when creating URL to get data
  *
  */
  function getData (coords) {
    //Closes any open popups
    //Removes old icons
    //Removes list of stops
    if(map){
      map.closePopup()
      stopIcons.forEach(icon => {
        map.getPanes().markerPane.removeChild(icon['_icon'])

      })
      d3.select("#stops").selectAll("div").remove()
      stopIcons = []
    }

    var url = `/stops/${coords[1]}/${coords[0]}`

    console.log('url', url)

    fetch(url).then(function(response) {
      return response.json();
    }).then(function(data) {
      data['data'].map((busStop,i) => {
       
        //Creates Icon
        var scoords =[busStop['stop_lat'],busStop['stop_lon']]     
        var sIcon = L.divIcon({ 
          className:'stopIcon ' + busStop.stop_id
        });
        var sMarker = L.marker([scoords[0], scoords[1]], {icon: sIcon,stop_id:busStop.stop_id})

        //Creates Popup
        var popupContent = `${busStop.stop_name}`
        sMarker.bindPopup(popupContent)

        //Onclick function for markers
        sMarker.on('click', e => {
          backgroundColorToggle(busStop.stop_id)
        })

        //Add marker to array of markers and map
        stopIcons.push(sMarker)
        sMarker.addTo(map)


        //Add stop to the list of stops
        var parentDiv = d3.select('#stops')
          .append('div')
          .attr('class',"stopListEntry stop_"+busStop.stop_id)
          .text((i+1) +". "+busStop.stop_name)
          .on('click',() => {
            var clickedStop = stopIcons.filter(stop => stop['options']['stop_id'] == busStop.stop_id)[0]
            clickedStop.openPopup()
            backgroundColorToggle(busStop.stop_id)
          })

        //Add desired data to list
        Object.keys(busStop).forEach(dataKey => {
          if(displayedDataKeys.includes(dataKey)){
            parentDiv
              .append('div')
                .attr("class","stopListData")
                .text(formattedDataKeys[dataKey] + ": "+ busStop[dataKey])          
          }
        })//end stop list

      });//end map
    });//end fetch
  }

  getData(start)

  var map = L.map('map').setView(start, 13);

  L.tileLayer('https://api.mapbox.com/styles/v1/am3081/cj654cp7l5xfq2rr4ce5iyo1c/tiles/256/{z}/{x}/{y}?access_token=pk.eyJ1IjoiYW0zMDgxIiwiYSI6IkxzS0FpU0UifQ.rYv6mHCcNd7KKMs7yhY3rw', {
    maxZoom: 18
  }).addTo(map);


  marker = new L.marker(start, {draggable:'true'});
  marker.on('dragend', function(event){
    var marker = event.target;
    var position = marker.getLatLng();
    marker.setLatLng(new L.LatLng(position.lat, position.lng),{draggable:'true'});
    map.panTo(new L.LatLng(position.lat, position.lng))
    getData([position.lat, position.lng])
  });
  map.addLayer(marker);

</script>